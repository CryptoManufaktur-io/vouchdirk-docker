version: "3.4"
x-logging: &logging
  logging:
    driver: json-file
    options:
      max-size: 10m
      max-file: "3"
      tag: '{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}'

services:
  prometheus:
    restart: unless-stopped
    build:
      context: ./prometheus
    image: prometheus:vd-local
    volumes:
      - prom-data:/prometheus
      - /etc/localtime:/etc/localtime:ro
    environment:
      - CLIENT=${COMPOSE_FILE}
    entrypoint: choose-config.sh
    command: ["/bin/prometheus", "--storage.tsdb.path=/prometheus", "--web.console.libraries=/usr/share/prometheus/console_libraries", "--web.console.templates=/usr/share/prometheus/consoles"]
    <<: *logging
    labels:
      - traefik.enable=true
      - traefik.http.routers.${PROM_HOST}.entrypoints=web,websecure
      - traefik.http.routers.${PROM_HOST}.rule=Host(`${PROM_HOST}.${DOMAIN}`)
      - traefik.http.routers.${PROM_HOST}.tls.certresolver=letsencrypt
      - traefik.http.services.${PROM_HOST}.loadbalancer.server.port=9090

volumes:
  prom-data:
